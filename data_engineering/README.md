**Dispersão dos moradores de rua no Brasil sob a perspectiva geoespacial e multidimensional.**             
`Última atualização: 16/09/2023 as 03:08.` 


## Objetivo(s)/resultados...

Urge com o próposito de direcionar políticas, recursos e estratégias de intervenção/assistência social e mitigar os desafios enfrentados por essa população vulnerável, promovendo uma sociedade mais justa e inclusiva. 

Assuntos a serem explorados:
<dl>
    <dd>

#### Populacionais/espaciais: quantificar os indivíduos em situação de vulnerabilidade habitacional e mapear sua distribuição geográfica em território nacional.

**1.** Quantos indivíduos em condição de sem-teto são registrados no território brasileiro?

<details open><summary>...</summary>

<img src="https://github.com/mouraxy/puc/blob/main/data_engineering/img/historico_pop_rua.png" align="left"
     alt="historico_pop_rua">

***Resposta:** <br>De acordo com os dados mais recentes, que datam de 2021, o Brasil contava com 158.057 pessoas em situação de rua, refletindo uma diminuição em relação ao ápice observado em 2020, quando o número atingiu 194.824 indivíduos. Essas informações foram coletadas pelas administrações municipais e consolidadas por meio de uma colaboração entre o Ministério da Cidadania e o Observatório Brasileiro de Políticas Públicas.*

<img src="https://github.com/mouraxy/puc/blob/main/data_engineering/img/link.svg" align="center" align="left" 
     alt="acessar-dados"> [‎ Acessar os dados...](https://github.com/mouraxy/puc/blob/main/data_engineering/consultas/historico_pop_rua.csv)

<br>

**1.1** Por município (n25)?

<details open><summary>...</summary>

<img src="https://github.com/mouraxy/puc/blob/main/data_engineering/img/pop_rua_municipios.PNG" align="left"
     alt="pop_rua_municipios">

***Resposta:** <br>São Paulo lidera a lista dos 25 municípios com o maior número de pessoas em situação de rua, com um total de 37.200 indivíduos. Isso representa quatro vezes mais do que o número registrado em Belo Horizonte (segundo colocado).*

<br><br><br><br>

<img src="https://github.com/mouraxy/puc/blob/main/data_engineering/img/link.svg" align="center" align="left" 
     alt="acessar-dados"> [‎ Acessar os dados...](https://github.com/mouraxy/puc/blob/main/data_engineering/consultas/pop_rua_municipios.csv)
     
<br>

</details>

**1.2** Por porte municipal?

<details><summary>...</summary>

<img src="https://github.com/mouraxy/puc/blob/main/data_engineering/img/pop_rua_porte.PNG" align="left"
     alt="pop_rua_porte">

***Resposta:** <br>81.286 moradores em situação de rua se concentram nas metrópoles e 54.685 nas cidades grandes. Embora essas áreas urbanas representem somente 5% dos municípios do país (283 de 5.570), elas concentram 86,02% do contingente destas pessoas.*

<br><br><br><br>

<img src="https://github.com/mouraxy/puc/blob/main/data_engineering/img/link.svg" align="center" align="left" 
     alt="acessar-dados"> [‎ Acessar os dados...](https://github.com/mouraxy/puc/blob/main/data_engineering/consultas/pop_rua_porte.csv)
     
<br>

</details>

**1.3** Por unidade federativa?

<details open><summary>...</summary>

<img src="https://github.com/mouraxy/puc/blob/main/data_engineering/img/pop_rua_uf.PNG" align="left"
     alt="pop_rua_uf">

***Resposta:** <br>O estado de São Paulo abriga uma população de 64.570 indivíduos vivendo em situação de rua, o qual representa uma parcela substancial de 40,8% de todo o contingente de pessoas nessa condição em território brasileiro. Notavelmente, essa estatística é 3,45 vezes superior à registrada em Minas Gerais e 4,76 vezes maior do que a do Rio de Janeiro.*

<br>

<img src="https://github.com/mouraxy/puc/blob/main/data_engineering/img/link.svg" align="center" align="left" 
     alt="acessar-dados"> [‎ Acessar os dados...](https://github.com/mouraxy/puc/blob/main/data_engineering/consultas/pop_rua_uf.csv)
     
<br>

</details>

</details>

**2.** Qual é a proporção da população brasileira que se encontra em situação de rua?

<details open><summary>...</summary>

**2.1** Por município?

<details><summary>...</summary>

<img src="https://github.com/mouraxy/puc/blob/main/data_engineering/img/%25pop_rua_municipios.PNG" align="left"
     alt="%pop_rua_municipios">

***Resposta:** <br> Boa Vista se sobressai como a cidade brasileira com a maior proporção de moradores em situação de rua em relação à sua população total. Além disso, a cidade registrou um notável crescimento populacional, passando de 284.313 habitantes em 2010 para 408.157 em 2022, um aumento de 30,34%.*

<br><br>

<img src="https://github.com/mouraxy/puc/blob/main/data_engineering/img/link.svg" align="center" align="left" 
     alt="acessar-dados"> [‎ Acessar os dados...](https://github.com/mouraxy/puc/blob/main/data_engineering/consultas/%25pop_rua_municipios.csv)
     
<br>

</details>

**2.2** Por porte municipal?

<details><summary>...</summary>

<img src="https://github.com/mouraxy/puc/blob/main/data_engineering/img/%25pop_rua_porte.PNG" align="left"
     alt="%pop_rua_porte">

***Resposta:** <br>Embora a população de moradores de rua represente cerca de 0,08% da população total, essa parcela se concentra nas grandes metrópoles, com uma taxa de 0,183%. Essa taxa é mais de 2 vezes superior à média nacional, indicando que as metrópoles abrigam uma parcela desproporcionalmente maior em comparação com o país como um todo.*

<br>

<img src="https://github.com/mouraxy/puc/blob/main/data_engineering/img/link.svg" align="center" align="left" 
     alt="acessar-dados"> [‎ Acessar os dados...](https://github.com/mouraxy/puc/blob/main/data_engineering/consultas/%25pop_rua_porte.csv)
     
<br>

</details>

**2.3** Por unidade federativa?

<details><summary>...</summary>

<img src="https://github.com/mouraxy/puc/blob/main/data_engineering/img/%25pop_rua_uf.PNG" align="left"
     alt="%pop_rua_uf">

***Resposta:** <br>Rondônia é o estado com a maior proporção de moradores de rua em relação à sua população total, registrando 0,309% (censo de 2022). Em segundo lugar está o Distrito Federal com 0,189% e São Paulo com 0,140%.*

<br><br><br><br><br>

<img src="https://github.com/mouraxy/puc/blob/main/data_engineering/img/link.svg" align="center" align="left" 
     alt="acessar-dados"> [‎ Acessar os dados...](https://github.com/mouraxy/puc/blob/main/data_engineering/consultas/%25pop_rua_uf.csv)
     
<br>

</details>

</details>

**3.** Quando e quais foram os maiores crescimentos ou declínios populacionais para o grupo em questão?

<details open><summary>...</summary>

<img src="https://github.com/mouraxy/puc/blob/main/data_engineering/img/variacao_pop_rua.PNG" align="left"
     alt="%var_pop_rua">

***Resposta:** <br>Desde o início da coleta de dados em 2012, os anos de 2013 e 2014 destacaram-se como os maiores aumentos na população em situação de rua, registrando crescimentos de 79% e 63%. Desde então, ocorreu somente uma diminuição, de -19% em 2019.*

<br><br><br><br>

<img src="https://github.com/mouraxy/puc/blob/main/data_engineering/img/link.svg" align="center" align="left" 
     alt="acessar-dados"> [‎ Acessar os dados...](https://github.com/mouraxy/puc/blob/main/data_engineering/consultas/historico_%25var_pop_rua.csv)
     
<br>

**3.1** Por município (n25)?

<details open><summary>...</summary>

<img src="https://github.com/mouraxy/puc/blob/main/data_engineering/img/%25var_pop_rua_municipios.PNG" align="left"
     alt="%var_pop_rua_municipios">

***Resposta:** <br>No período de 2018 a 2022, Porto Alegre e Goiânia se destacaram pelos maiores declínios na população em situação de rua, com reduções de -16% e -11%. Por outro lado, Salvador, Joinville e Boa Vista apresentaram crescimentos superiores a 80% no número de moradores de rua durante o mesmo período.*

<br><br><br>

<img src="https://github.com/mouraxy/puc/blob/main/data_engineering/img/link.svg" align="center" align="left" 
     alt="acessar-dados"> [‎ Acessar os dados...](https://github.com/mouraxy/puc/blob/main/data_engineering/consultas/%25var_pop_rua_municipios.csv)
     
<br>

</details>

**3.2** Por porte municipal?

<details><summary>...</summary>

<img src="https://github.com/mouraxy/puc/blob/main/data_engineering/img/%25var_pop_rua_porte.PNG" align="left"
     alt="%var_pop_rua_porte">

***Resposta:** <br> Embora tenha ocorrido um aumento de 14% entre 2018 e 2021 na população em situação de rua, esse acréscimo foi ainda mais substancial nas pequenas e médias cidades, onde as taxas excederam os 30%. É importante frisar que essa tendência não necessariamente reflete os maiores aumentos em termos absolutos.*

<br><br><br>

<img src="https://github.com/mouraxy/puc/blob/main/data_engineering/img/link.svg" align="center" align="left" 
     alt="acessar-dados"> [‎ Acessar os dados...](https://github.com/mouraxy/puc/blob/main/data_engineering/consultas/%25var_pop_rua_porte.csv)
     
<br>

</details>

**3.3** Por unidade federativa?

<details><summary>...</summary>

<img src="https://github.com/mouraxy/puc/blob/main/data_engineering/img/%25var_pop_rua_uf.PNG" align="left"
     alt="%var_pop_rua_uf">

***Resposta:** <br>De 2018 a 2021, Roraima e Bahia viram suas populações de moradores de rua crescerem em 88% e 86%, enquanto Alagoas e Acre tiveram reduções de -23% e -13%. São Paulo e Rio Grande do Sul permaneceram relativamente estáveis em termos proporcionais.*

<br><br><br><br>

<img src="https://github.com/mouraxy/puc/blob/main/data_engineering/img/link.svg" align="center" align="left" 
     alt="acessar-dados"> [‎ Acessar os dados...](https://github.com/mouraxy/puc/blob/main/data_engineering/consultas/%25var_pop_rua_uf.csv)
     
<br>

</details>

</details>

**4.** A densidade demográfica está relacionada à concentração absoluta ou proporcional de pessoas em situação de rua?

<details><summary>...</summary>

***Resposta:** <br> Nos 25 municípios com a maior incidência de moradores em situação de rua, observa-se uma densidade média de 3.237 habitantes por quilômetro quadrado, enquanto nos demais municípios essa média se situa em 104 habitantes por quilômetro quadrado. Esse indicador ressalta a tendência de concentração dos indivíduos em situação de rua nas áreas urbanas caracterizadas por uma elevada densidade demográfica. É relevante notar que, dentre os 5.570 municípios do país, dados referentes à população em situação de rua não foram disponibilizados em 1.700 deles.*
     
</details>

<br>

#### Econômicos: associar o percentual médio de desempregados com as oscilações históricas dos desabrigados.

**1.** Qual é o coeficiente de correlação (*r*) entre as variáveis? Existe uma associação significativa entre elas?

<details open><summary>...</summary>

<img src="https://github.com/mouraxy/puc/blob/main/data_engineering/img/correlacao_desemprego.PNG" align="left"
     alt="correlacao_desemprego">

***Resposta:** <br> A correlação (r) é de aproximadamente 0,8983 (forte correlação positiva).* <br><br>  *Ou seja, à medida que a taxa média de desemprego aumenta, a população em situação de rua tende a aumentar também.*
​
<br><br><br><br><br><br>

<img src="https://github.com/mouraxy/puc/blob/main/data_engineering/img/link.svg" align="center" align="left" 
     alt="acessar-dados"> [‎ Acessar os dados...](https://github.com/mouraxy/puc/blob/main/data_engineering/consultas/historico_tx_desemprego.csv)
     
<br>

</details>

**2.** Em caso afirmativo, em quais situações elas apresentam uma maior ou menor relação?

<details><summary>...</summary>

<img src="https://github.com/mouraxy/puc/blob/main/data_engineering/img/convergencia_estatistica.PNG" align="left"
     alt="convergencia_estatistica">

***Resposta:** <br> Nos anos de 2013 e 2014, observa-se uma notável disparidade nos valores estatísticos, com percentuais de 80,51% e 69,01%, respectivamente. <br><br> Em contraste, os anos de 2016 e 2020 se destacam por apresentarem uma estreita concordância estatística, com diferenças ínfimas de apenas 5,25% e -0,91%, respectivamente.*

<br>

<img src="https://github.com/mouraxy/puc/blob/main/data_engineering/img/link.svg" align="center" align="left" 
     alt="acessar-dados"> [‎ Acessar os dados...](https://github.com/mouraxy/puc/blob/main/data_engineering/consultas/%25var_tx_desemprego.csv)
     
<br>

</details>

<br>

#### Climáticos: identificar situações climáticas adversas, associadas ao risco hipotérmico e suscetibilidade a doenças.

**1.** Para os 25 municípios com as maiores concentrações de moradores em situação de rua...

<details><summary>...</summary>

**1.1** Quais experimentam mais dias frios (< 13ºC) ao longo do ano, em média?

<img src="https://github.com/mouraxy/puc/blob/main/data_engineering/img/temperatura_municipios.PNG" align="left"
     alt="temperatura_municipios">

***Resposta:** <br> Em média, de 2019 a 2022, cidades como Sorocaba, Osasco, Porto Alegre, Campinas, São Bernardo, Guarulhos e São Paulo registraram mais de 40 dias com temperaturas mínimas inferiores a 13°C. Curitiba teve o maior valor, com 134 dias.<br><br>Em resumo, 90.479 pessoas (57,25% de toda a população em situação de rua do Brasil) estariam suscetíveis à hipotermia em 10% dos dias do ano.*

<img src="https://github.com/mouraxy/puc/blob/main/data_engineering/img/link.svg" align="center" align="left" 
     alt="acessar-dados"> [‎ Acessar os dados...](https://github.com/mouraxy/puc/blob/main/data_engineering/consultas/temp_inf_13_municipios.csv)
     
<br>

**1.2** Quais destes são mais suscetíveis a enchentes (> 50mm) ao longo do ano, em média?

<img src="https://github.com/mouraxy/puc/blob/main/data_engineering/img/pluviosidade_municipios.PNG" align="left"
     alt="pluviosidade_municipios">

***Resposta:** <br>No período de 2019 a 2022, as cidades de Manaus, Salvador, Joinville, Fortaleza, Brasília e Florianópolis experimentaram, em média, entre 10 e 5 chuvas superiores a 50mm por ano.<br><br>Para as demais 19 cidades, a média manteve-se em aproximadamente 4 dias anuais com esse nível de precipitação.*

<br><br>

<img src="https://github.com/mouraxy/puc/blob/main/data_engineering/img/link.svg" align="center" align="left" 
     alt="acessar-dados"> [‎ Acessar os dados...](https://github.com/mouraxy/puc/blob/main/data_engineering/consultas/pluv_sup_50_municipios.csv)
     
<br>

</details>

  </dd>
</dl>
   
  </dd>
</dl>

## Coleta...
<dl>
    <dd>
         
<details open><summary>Dados e armazenamento...</summary>
<br>

Foram compiladas 1773 tabelas provenientes da internet com formatos e estruturas diversas. Esta seleção objetivou emular cenários realistas de engenharia de dados, os quais frequentemente transcendem tabelas simples com dados homogêneos.

| arquivo                                   | fonte                                                                                    | tamanho (bytes) |
|:---------------------------------------------------|:----------------------------------------------------------------------------------------:|:-----------------:|
| 2019.zip                                          | [Baixar](https://portal.inmet.gov.br/uploads/dadoshistoricos/2019.zip)             | 117,560,201     |
| 2020.zip                                          | [Baixar](https://portal.inmet.gov.br/uploads/dadoshistoricos/2020.zip)             | 103,653,055     |
| 2021.zip                                          | [Baixar](https://portal.inmet.gov.br/uploads/dadoshistoricos/2021.zip)             | 80,571,564      |
| AR_BR_RG_UF_RGINT_MES_MIC_MUN_2022.xls            | [Baixar](https://geoftp.ibge.gov.br/organizacao_do_territorio/estrutura_territorial/areas_territoriais/2022/AR_BR_RG_UF_RGINT_MES_MIC_MUN_2022.xls)             | 1,095,168       |
| POP2022_Municipios_20230622.xls                   | [Baixar](https://ftp.ibge.gov.br/Censos/Censo_Demografico_2022/Previa_da_Populacao/POP2022_Municipios_20230622.xls) | 757,760         |
| Lista_Municipios_com_IBGE_Brasil_Versao_CSV.csv   | [Baixar](http://blog.mds.gov.br/redesuas/wp-content/uploads/2018/06/Lista_Munic%C3%ADpios_com_IBGE_Brasil_Versao_CSV.csv) | 448,527         |
| municipios_serie_historica_pop_rua.csv           | [Baixar](https://obpoprua.direito.ufmg.br/tabelas/municipios_serie_historica_pop_rua.xlsx) | 430,606         |
| municipios.csv                                    | [Baixar](https://raw.githubusercontent.com/kelvins/Municipios-Brasileiros/main/csv/municipios.csv) | 390,119         |
| 20230827084621.csv‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎                                | [Baixar‎](https://www.ibge.gov.br/estatisticas/sociais/trabalho/9173-pesquisa-nacional-por-amostra-de-domicilios-continua-trimestral.html?=&t=series-historicas&utm_source=landing&utm_medium=explica&utm_campaign=desemprego) | ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ 3,020 ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎‎ ‎  |

## Pipeline ...

Todos os conjuntos de dados foram armazenados no `Data Lake Storage Gen2`, o Datalake da Microsoft. Para essa etapa, foi utilizado o `Azure Data Factory`, uma ferramenta para criar pipelines de ingestão automatizada.

  > <b>...</b> <br>
O pipeline centralizou os conjuntos de dados com diferentes fontes e formatos no Data Lake (exceto das EMA's, devido a quantidade de arquivos).

<details><summary><b>Ver pipeline...</b></summary>

<img src="https://github.com/mouraxy/puc/blob/main/data_engineering/img/pipeline.PNG" align="left"
     alt="pipeline">

<br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br>

</details>

#### Erros de conexão...

Para garantir a integridade dos dados e evitar possíveis erros de conexão, implementou-se um tratamento de erros. Um aplicativo lógico foi configurado para monitorar a conexão e, caso ocorressem problemas, acionaria uma notificação por e-mail.

<dl>
    <dd>

<details><summary>Configuração do aplicativo lógico...</summary>
  
<br>
  
```json
{
    "properties": {
        "DataFactoryName": {
            "type": "string"
        },
        "ErrorMessage": {
            "type": "string"
        },
        "Pipeline": {
            "type": "string"
        },
        "Runid": {
            "type": "string"
        }
    },
    "type": "object"
}
```
</details>

  </dd>
</dl>

</details>

  </dd>
</dl>
    
## Modelagem...
  <dl>
    <dd>

  <details open><summary>Organização dos dados...</summary>
  
  ## *Star schema...*
  Modelo em data warehouses, o Star Schema conecta tabela de `fatos` e `dimensões` por indentificadores distintos, formando uma estrutura de estrela. 
  
  > <b>...</b> <br>
  Embora reduza a necessidade de junções complexas, armazenamento e redundância são possíveis riscos associados.
  
  <br>Dado seu enfoque em ambientes de Business Intelligence (BI), `este modelo será incorporado ao MVP` com as respectivas **[tabelas...](https://github.com/mouraxy/puc/tree/main/data_engineering/data_lake)**
  
  </details>
  
  <details open><summary>Metadados...</summary>

  ## Catálogo de dados...
  Um catálogo ou dicionário de dados é uma estrutura de governança e consiste em uma compilação de metadados em uma disposição informacional.
  
  ```Entidade: FACT_POP_RUA```
  | id | variavel                                     | tipo          | minimo       | maximo       | fonte                                                                                                           |
  |----|:---------------------------------------------|:-----:|:------------:|:------------:|:-----------------------------------------------------------------------------------------------------------------------:|       
  | 1  | id_municipio                                 |‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ inteiro‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ | 1.100.015    | 5.222.203    | [SNAS²](http://blog.mds.gov.br/redesuas/wp-content/uploads/2018/06/Lista_Munic%C3%ADpios_com_IBGE_Brasil_Versao_CSV.csv) |
  | 2  | id_porte                                     |inteiro‎|‎‎1‎‎ |‎ ‎ ‎ ‎ ‎ ‎ 5‎ ‎ ‎ ‎ ‎ ‎   |[SNAS²](http://blog.mds.gov.br/redesuas/wp-content/uploads/2018/06/Lista_Munic%C3%ADpios_com_IBGE_Brasil_Versao_CSV.csv) |
  | 3  | id_uf                                        |inteiro| 1            | 27           | [SNAS²](http://blog.mds.gov.br/redesuas/wp-content/uploads/2018/06/Lista_Munic%C3%ADpios_com_IBGE_Brasil_Versao_CSV.csv) |
  | 4  | id_regiao                                    |inteiro| 1            | 5            | [SNAS²](http://blog.mds.gov.br/redesuas/wp-content/uploads/2018/06/Lista_Munic%C3%ADpios_com_IBGE_Brasil_Versao_CSV.csv) |
  | 5  | latitude                                     |decimal| -33,69       | 4,60         | [Github](https://raw.githubusercontent.com/kelvins/Municipios-Brasileiros/main/csv/municipios.csv)                       |
  | 6  | longitude                                    |decimal‎|‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ -72,90‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ | -32,41       | [Github](https://raw.githubusercontent.com/kelvins/Municipios-Brasileiros/main/csv/municipios.csv)                       |
  | 7  | area_municipio                                    |decimal‎|‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ 3,565‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ | 159.533,306       | [IBGE¹](https://geoftp.ibge.gov.br/organizacao_do_territorio/estrutura_territorial/areas_territoriais/2022/AR_BR_RG_UF_RGINT_MES_MIC_MUN_2022.xls)                       |
  | 8  | pop_censo_2010‎‎‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎  ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎  ‎ ‎ ‎ ‎ ‎   |inteiro| 805          |‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ 11.253.503‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ | [SNAS²](http://blog.mds.gov.br/redesuas/wp-content/uploads/2018/06/Lista_Munic%C3%ADpios_com_IBGE_Brasil_Versao_CSV.csv) |
  | 9  | pop_censo_2022‎‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎‎| inteiro      | 836            | 12.200.180            | [IBGE¹](https://ftp.ibge.gov.br/Censos/Censo_Demografico_2022/Previa_da_Populacao/POP2022_Municipios_20230622.xls)          |
  | 10  | pop_rua                                      | inteiro       | 0            | 48.134       | [UFMG³](https://obpoprua.direito.ufmg.br/tabelas/municipios_serie_historica_pop_rua.xlsx)                        |
  | 11  | pop_rua_ano                                  | inteiro       |     2012     | 2021         | [UFMG³](https://obpoprua.direito.ufmg.br/tabelas/municipios_serie_historica_pop_rua.xlsx)                        |
  | 12  | taxa_desemprego_media                                  | decimal       |     6,875     | 13,5         | [IBGE¹](https://www.ibge.gov.br/estatisticas/sociais/trabalho/9173-pesquisa-nacional-por-amostra-de-domicilios-continua-trimestral.html?=&t=series-historicas&utm_source=landing&utm_medium=explica&utm_campaign=desemprego)                        |
  | 13  | estacao_meteorologica                                  | texto       |     -     | -         | [INMET⁴](https://portal.inmet.gov.br/dadoshistoricos)           
  | 14  | temp_sub_13                                 | decimal       |     0     | 247         | [INMET⁴](https://portal.inmet.gov.br/dadoshistoricos)  
  | 15  | pluv_sup_50                                  | decimal       |     0     | 12,5         | [INMET⁴](https://portal.inmet.gov.br/dadoshistoricos)  

  <sub>¹ Instituto Brasileiro de Geografia e Estatística<br>
  ² Sistema Nacional de Assistência Social<br>
  ³ Universidade Federal de Minas Gerais<br>
  ⁴ Instituto Nacional de Meteorologia<br>
  </sub>

| id  | descricao                                       |
| --- |:----------------------------------------------- |
| 1   | Identificador único do município brasileiro.|
| 2   | Identificador do porte do município.             |
| 3   | Identificador da unidade federativa (UF).        |
| 4   | Identificador da região geográfica.              |
| 5   | Latitude da localização do município.           |
| 6   | Longitude da localização do município.          |
| 7   | Área do município em quilômetros quadrados.     |
| 8   | População municipal no censo de 2010.           |
| 9   | População municipal no censo de 2022.            |
| 10  | População em situação de rua.                    |
| 11  | Ano da estimativa da população em situação de rua.|
| 12  | Taxa média de desemprego.                        |
| 13  | Estação meteorológica utilizada (por proximidade ao municipio). |
| 14  | Médias de dias em que foram registradas temperaturas abaixo de 13°C na estação meteorológica.‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎‎ ‎ ‎  ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎‎ ‎  ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ |
| 15  | Médias de dias em que a precipitação pluviométrica ultrapassou 50mm na estação meteorológica. |

  </details>

  </dd>
</dl>

## Carga...

`Databricks` <img align="center" src="https://cdn.safe.com/wp-content/uploads/sites/2/2023/03/27112124/databricks-icon.svg" alt="drawing" width="18"/> é uma plataforma escalável em nuvem que harmoniza os processos de Extração, Transformação e Carga (ETL) paralelamente.

> <b>...</b> <br>
Execução paralela envolve a realização simultânea de diversas operações visando otimizar a eficiência computacional.

<br>O uso do Databricks se mostra mais vantajoso em comparação ao emprego do **[expressor de consultas](https://learn.microsoft.com/en-us/azure/data-factory/data-flow-transformation-overview)** do `Azure Data Factory` <img align="center" src="https://ww1.freelogovectors.net/wp-content/uploads/2022/03/azure_data_factory_logo_freelogovectors.net_.png" alt="drawing" width="18"/>, devido à relativa complexidade estrutural do projeto e à capacidade de integração de linguagens (Python e SQL), além de conectores diversificados. 
<br>

<dl>
    <dd>
         
### Código ETL...

`Ponto de montagem...`
Recuperar os dados do contêiner (diretório) associado ao Data Lake da Azure.

<details><summary>Mostrar código...</summary>

```py
# Conectar-se ao Data Lake...
dbutils.fs.mount( 
    source = "wasbs://dados@engdadosmvp.blob.core.windows.net", 
    mount_point = "/mnt/dados",
    extra_configs = {"fs.azure.account.key.engdadosmvp.blob.core.windows.net":"chave-de-acesso"})
```

</details>

</details>

<br>

`Ler aquivos...`
Criar DataFrames/visualizações temporárias com os dados do DL para tratativas subsequentes.

<details><summary>Mostrar código...</summary>

```py
df_coordenadas_dos_municipios = spark.read.format("csv")\
                                          .option("sep", ",")\
                                          .option("header", "true")\
                                          .option("inferSchema", "true")\
                                          .load("/mnt/dados/municipios.csv")
```

```py
df_pop_censo_2022 = pd.read_excel('/dbfs/mnt/dados/POP2022_Municipios_20230622.xls',
                    skiprows=1,
                            dtype={
                                'COD. UF':str,
                                'COD. MUNIC':str,
                                'POPULAÇÃO':str
                            }                   
).dropna(thresh=2)

df_area_munic = pd.read_excel('/dbfs/mnt/dados/AR_BR_RG_UF_RGINT_MES_MIC_MUN_2022.xls', 
                      sheet_name='AR_BR_MUN_2022', 
                      usecols=[4, 6]
)

df_taxa_desemprego_media = pd.read_csv("/dbfs/mnt/dados/20230827084621.csv",
                        sep = ';',
                        skiprows=1,
).dropna().transpose()

```

```py
PASTA_CAMINHO = '/dbfs/mnt/dados/'
ARQUIVOS = ['2019', '2020', '2021', '2022']

df_estacao_meteorologica = pd.read_csv(f'{PASTA_CAMINHO}{"estacoes_meteorologicas_br.csv"}',
                             sep=';'
)

def processar_arquivos(caminho_arquivo):
    tabelas = []
    nomes_arquivos = []
    total_linhas = []

    with zipfile.ZipFile(caminho_arquivo) as z:
        for nome_arquivo_interno in z.namelist():
            if nome_arquivo_interno.endswith('.CSV'):
                with z.open(nome_arquivo_interno) as f:
                    df = pd.read_csv(
                        f,
                        sep=';',
                        skiprows=8,
                        encoding='cp1252',
                        usecols=[0, 2, 10],
                        dtype={0: 'str', 2: 'float', 10: 'float'},
                        decimal=','
                    )

                    df['Nome_Arquivo'] = nome_arquivo_interno
                    nomes_arquivos.append(nome_arquivo_interno)
                    tabelas.append(df)
                    total_linhas.append(len(df))

    return tabelas, nomes_arquivos, total_linhas 

def main():
    tabelas_total = []
    nomes_arquivos_total = []
    df_log_data = []

    for nome_arquivo in os.listdir(PASTA_CAMINHO):
        if any(ano in nome_arquivo for ano in ARQUIVOS) and nome_arquivo.endswith('.zip'):
            caminho_zip = os.path.join(PASTA_CAMINHO, nome_arquivo)
            tabelas, nomes_arquivos, total_linhas = processar_arquivos(caminho_zip)

            df_log_data.extend([{'nomes_arquivos_lidos': nome_arquivo, 'total_linhas': total_linhas_tabela}
                                for nome_arquivo, total_linhas_tabela in zip(nomes_arquivos, total_linhas)])

            tabelas_total.extend(tabelas)
            nomes_arquivos_total.extend(nomes_arquivos)

    df_log = pd.DataFrame(df_log_data)
    return tabelas_total

if __name__ == "__main__":
    tabelas_total = main()
    df_inmet = pd.concat(tabelas_total, ignore_index=True)
```

```py
df_pop_rua = spark.read.format("csv")\
                                  .option("sep", ";")\
                                  .option("header", "true")\
                                  .option("inferSchema", "true")\
                                  .load("/mnt/dados/municipios_serie_historica_pop_rua.csv")
```

```py
df_pop_censo_2010 = spark.read.format("csv")\
                                          .option("sep", ";")\
                                          .option("header", "true")\
                                          .option("inferSchema", "true") \
                                          .load("/mnt/dados/Lista_Municípios_com_IBGE_Brasil_Versao_CSV.csv")
```

</details>

<br>

`Tratar dados...` Renomear e remover variáveis. Também reestruturar as tabelas seguindo o modelo de dados estrela. 
  
> <b>...</b> <br>
A criação de um DW nesse esquema facilitará substancialmente o trabalho no Power BI.

<details><summary>Mostrar código...</summary>

```py
def transformar_nome_arquivo(nome):
    return nome.split('_')[4]

def main():
    df_inmet['Data'] = pd.to_datetime(df_inmet['Data'])
    df_inmet['Ano'] = df_inmet['Data'].dt.year

    pluviosidade_por_dia_filtrado = (
        df_inmet.groupby(['Data', 'Ano', 'Nome_Arquivo'])['PRECIPITAÇÃO TOTAL, HORÁRIO (mm)']
        .sum()
        .reset_index()
    )
    
    pluviosidade_por_dia_filtrado = pluviosidade_por_dia_filtrado[pluviosidade_por_dia_filtrado['PRECIPITAÇÃO TOTAL, HORÁRIO (mm)'] > 50]
    pluviosidade_por_dia_filtrado['Nome_Arquivo'] = pluviosidade_por_dia_filtrado['Nome_Arquivo'].apply(transformar_nome_arquivo)
    pluviosidade_por_dia_filtrado['id_dt_municipio'] = pluviosidade_por_dia_filtrado['Data'].astype(str) + pluviosidade_por_dia_filtrado['Nome_Arquivo']
    pluviosidade_por_dia_filtrado.drop_duplicates(subset='id_dt_municipio', inplace=True)
    
    resumo_pluviosidade = (
        pluviosidade_por_dia_filtrado.groupby(['Nome_Arquivo'])
        .size()
        .reset_index(name='dias_precip_>50mm')
    )
    
    resumo_pluviosidade['pluv_sup_50'] = (resumo_pluviosidade['dias_precip_>50mm']/len(ARQUIVOS)).astype(str)
    resumo_pluviosidade['pluv_sup_50'] = resumo_pluviosidade['pluv_sup_50'].str.replace('.', ',')

    temperatura_abaixo_de_13 = df_inmet[df_inmet['TEMPERATURA MÍNIMA NA HORA ANT. (AUT) (°C)'] < 13]
    temperatura_abaixo_de_13['Nome_Arquivo'] = temperatura_abaixo_de_13['Nome_Arquivo'].apply(transformar_nome_arquivo)
    temperatura_abaixo_de_13['Data'] = temperatura_abaixo_de_13['Data'].astype(str)
    temperatura_abaixo_de_13['id_dt'] = temperatura_abaixo_de_13['Data'] + temperatura_abaixo_de_13['Nome_Arquivo']
    temperatura_abaixo_de_13 = temperatura_abaixo_de_13.drop_duplicates(subset=['id_dt'])
    
    resumo_temperatura_baixa = (
          temperatura_abaixo_de_13.groupby(['Nome_Arquivo'])
          .size()
          .reset_index(name='dias_temp_<13')
    )

    resumo_temperatura_baixa['temp_sub_13'] = (resumo_temperatura_baixa['dias_temp_<13'] / len(ARQUIVOS))
    limite_sup = resumo_temperatura_baixa['temp_sub_13'].mean() + 3.5*resumo_temperatura_baixa['temp_sub_13'].std()
    limite_inf = resumo_temperatura_baixa['temp_sub_13'].mean() - 3.5*resumo_temperatura_baixa['temp_sub_13'].std()
    resumo_temperatura_baixa = resumo_temperatura_baixa.loc[(resumo_temperatura_baixa['temp_sub_13'] <= limite_sup) & (resumo_temperatura_baixa['temp_sub_13'] >= limite_inf)]
    resumo_temperatura_baixa['temp_sub_13'] = resumo_temperatura_baixa['temp_sub_13'].astype(str)
    resumo_temperatura_baixa['temp_sub_13'] = resumo_temperatura_baixa['temp_sub_13'].str.replace('.', ',')

    return resumo_temperatura_baixa, resumo_pluviosidade

if __name__ == "__main__":
    resumo_temperatura_baixa, resumo_pluviosidade = main()
    main()
```

```py
df_coord_municipios = df_coordenadas_dos_municipios.toPandas()

manter_colunas = ['ESTACAO','LATITUDE', 'UF', 'LONGITUDE', 
                     'temp_sub_13', 'pluv_sup_50']  

df_unificado = pd.merge(df_estacao_meteorologica, resumo_temperatura_baixa, left_on='ESTACAO', right_on='Nome_Arquivo', how='left')
df_unificado = pd.merge(df_unificado, resumo_pluviosidade, left_on='ESTACAO', right_on='Nome_Arquivo', how='left')

df_unificado = df_unificado[manter_colunas]
df_unificado['ESTACAO'] = df_unificado['ESTACAO'].apply(lambda x: "ESTACAO METEOROLOGICA " + x)
df_unificado['LATITUDE'] = df_unificado['LATITUDE'].str.replace(',', '.')
df_unificado['LONGITUDE'] = df_unificado['LONGITUDE'].str.replace(',', '.')

def encontrar_estacao_mais_proxima(linha):
    distancias = df_unificado.apply(
        lambda r: great_circle((linha['latitude'], linha['longitude']), (r['LATITUDE'], r['LONGITUDE'])).kilometers,
        axis=1
    )
    indice_mais_proximo = distancias.idxmin()
    linha_mais_proxima = df_unificado.loc[indice_mais_proximo]
    return (
        linha_mais_proxima['ESTACAO'],
        linha_mais_proxima['temp_sub_13'],
        linha_mais_proxima['pluv_sup_50']
    )

resultados = df_coord_municipios.apply(encontrar_estacao_mais_proxima, axis=1)
df_coord_municipios[[
    'ESTACAO', 'temp_sub_13', 'pluv_sup_50'
]] = pd.DataFrame(
    resultados.to_list(),
    columns=['ESTACAO', 'temp_sub_13', 'pluv_sup_50']
)

df_coord_municipios = spark.createDataFrame(df_coord_municipios)
df_coord_municipios = df_coord_municipios.withColumnRenamed('ESTACAO', 'estacao_meteorologica')
df_coord_municipios.createOrReplaceTempView('DIM_COORD_MUNICIPIOS')
```

```py
df_pop_censo_2022['POPULAÇÃO'] = df_pop_censo_2022['POPULAÇÃO'].str.replace('.', '')
df_pop_censo_2022['POPULAÇÃO'] = df_pop_censo_2022['POPULAÇÃO'].str.split('(', expand=True)[0]
df_pop_censo_2022['POPULAÇÃO'] = df_pop_censo_2022['POPULAÇÃO'].astype(int)

df_pop_censo_2022["id_municipio"] = df_pop_censo_2022["COD. UF"] + df_pop_censo_2022["COD. MUNIC"]
df_pop_censo_2022.rename(columns={'POPULAÇÃO': 'pop_censo_2022'}, inplace=True)
df_pop_censo_2022['pop_censo_2022'] = df_pop_censo_2022['pop_censo_2022'].astype(float).astype(int)
df_pop_censo_2022 = spark.createDataFrame(df_pop_censo_2022)
df_pop_censo_2022.createOrReplaceTempView('DIM_POP_CENSO_2022')

df_area_munic = spark.createDataFrame(df_area_munic)
df_area_munic.createOrReplaceTempView('DIM_AREA_MUNIC')

df_taxa_desemprego_media = df_taxa_desemprego_media.reset_index()
df_taxa_desemprego_media.columns = ['ano', 'taxa_desemprego']
df_taxa_desemprego_media['ano'] = df_taxa_desemprego_media['ano'].str.split().str[-1]
df_taxa_desemprego_media = df_taxa_desemprego_media.groupby(['ano'])['taxa_desemprego'].mean().reset_index()
df_taxa_desemprego_media.rename(columns={'taxa_desemprego': 'taxa_desemprego_media'}, inplace=True)
df_taxa_desemprego_media = spark.createDataFrame(df_taxa_desemprego_media)
df_taxa_desemprego_media.createOrReplaceTempView('DIM_TAXA_DESEMPREGO_MEDIA')
```

```py
colunas_para_excluir = ['_c0']
df_pop_rua = df_pop_rua.drop(*colunas_para_excluir)

df_pop_rua = df_pop_rua.withColumnRenamed('codigo_ibg', 'id_municipio')\
                                             .withColumnRenamed('freq', 'pop_rua')\
                                             .withColumnRenamed('ano', 'pop_rua_ano')

df_pop_rua.createOrReplaceTempView("DIM_MORADORES_RUA")
```

```py
colunas_para_excluir = ['ConcatUF+Mun', 'IBGE', 'Capital', '_c9']
df_pop_censo_2010 = df_pop_censo_2010.drop(*colunas_para_excluir)

df_pop_censo_2010 = df_pop_censo_2010.withColumnRenamed('IBGE7', 'id_municipio')\
                             .withColumnRenamed('UF', 'uf')\
                             .withColumnRenamed('Município', 'municipio')\
                             .withColumnRenamed('Região', 'regiao')\
                             .withColumnRenamed('População 2010', 'pop_censo_2010')\
                             .withColumnRenamed('Porte', 'porte')
                             
df_pop_censo_2010.createOrReplaceTempView("MUNICIPIOS")
```

</details>

<br>

`Star schema`
Modificar a estrutura das tabelas para o modelo estrela.

<details><summary>Mostrar código...</summary>

```py
# Criação das tabelas dimensão...
df_pop_censo_2010_id = spark.sql(""" SELECT municipio
                          FROM MUNICIPIOS
                          ORDER BY municipio
""")

df_pop_censo_2010_id = df_pop_censo_2010_id.withColumn('id_municipio', monotonically_increasing_id()+1)
df_pop_censo_2010_id.createOrReplaceTempView('DIM_MUNICIPIOS')

df_regiao = spark.sql(""" SELECT DISTINCT regiao
                          FROM MUNICIPIOS
                          ORDER BY regiao
""")

df_regiao = df_regiao.withColumn('id_regiao', monotonically_increasing_id()+1)
df_regiao.createOrReplaceTempView('DIM_REGIAO')

df_estado = spark.sql(""" SELECT DISTINCT uf
                          FROM MUNICIPIOS
                          ORDER BY uf
""")

df_estado = df_estado.withColumn('id_uf', monotonically_increasing_id()+1)
df_estado.createOrReplaceTempView('DIM_UNIDADE_FEDERATIVA')

df_porte = spark.sql(""" SELECT DISTINCT porte
                          FROM MUNICIPIOS
                          ORDER BY porte
""")

df_porte = df_porte.withColumn('id_porte', monotonically_increasing_id()+1)
df_porte.createOrReplaceTempView('DIM_PORTE_MUNICIPIO')
```

```py
# Criação da tabela fato...
df_fato = spark.sql("""
                    SELECT 
                        M.id_municipio, P.id_porte, U.id_uf, R.id_regiao, C.latitude, C.longitude, AR.area_municipio,
                        M.pop_censo_2010, CXXII.pop_censo_2022, MR.pop_rua, MR.pop_rua_ano, TD.taxa_desemprego_media,
                        C.estacao_meteorologica, C.temp_sub_13, C.pluv_sup_50
                          
                        FROM MUNICIPIOS M
                        LEFT JOIN DIM_PORTE_MUNICIPIO P ON P.porte = M.porte
                        LEFT JOIN DIM_UNIDADE_FEDERATIVA U ON U.uf = M.uf
                        LEFT JOIN DIM_REGIAO R ON R.regiao = M.regiao
                        LEFT JOIN DIM_COORD_MUNICIPIOS C ON C.codigo_ibge = M.id_municipio
                        LEFT JOIN DIM_AREA_MUNIC AR ON AR.CD_MUN = M.id_municipio
                        LEFT JOIN DIM_POP_CENSO_2022 CXXII ON CXXII.id_municipio = M.id_municipio
                        LEFT JOIN DIM_MORADORES_RUA MR ON MR.id_municipio = M.id_municipio
                        LEFT JOIN DIM_TAXA_DESEMPREGO_MEDIA TD ON TD.ano = MR.pop_rua_ano

                        ORDER BY M.id_municipio
""")
```

</details>

<br>

`Carregar...`
Importar os dados para o banco de dados SQL na nuvem e para o Data Lake. 

  > <b>...</b> <br>
  Previamente, foi necessário preparar o ambiente na Azure por meio das instruções DDL. Você pode acessá-las **[aqui!](https://github.com/mouraxy/puc/blob/main/data_engineering/sql/ddl.sql)**

<details><summary>Mostrar código...</summary>

```py
# Enviar dados para o SQL
def carga_sql(df, tabela):
    df.write.format("jdbc")\
            .mode("append")\
            .option("url", "jdbc:sqlserver://mouraxy.database.windows.net")\
            .option("port", "1433")\
            .option("user", "mouraxy")\
            .option("password", "**********")\
            .option("database", "bd_mouraxy")\
            .option("dbtable", tabela)\
            .save()
```

```py
# Enviar dados para o Data Lake...
df_fato.coalesce(1)\
    .write\
    .format('csv')\
    .mode('overwrite')\
    .option("header", "true")\
    .save('/mnt/dados/spark/')

def mover_arquivos(extensao, origem, destino, novo_nome):
    files = dbutils.fs.ls(origem)
    for i in range (0, len(files)):
        file = files[i].name
        if extensao in file:
            dbutils.fs.cp(files[i].path, destino+novo_nome+extensao)
            print('Origem: '+file+'\nDestino: '+destino+novo_nome+extensao)

mover_arquivos('.csv', '/mnt/dados/spark/', '/mnt/dados/dw/', 'FACT_POP_RUA')
```

</details>

  </dd>
</dl>

## Revisão...

<dl>
 <dd>
  <details><summary>Qualidade de dados...</summary>
               
  </details>

  <details><summary>Comentários finais...</summary>
                          
  </details>

 </dd>
</dl>























