**Dispersão dos moradores de rua no Brasil sob a perspectiva geoespacial e multidimensional.**             
`Última atualização: 15/09/2023 as 03:08.` 


## Objetivo(s)/resultados...

Urge com o próposito de direcionar políticas, recursos e estratégias de intervenção/assistência social e mitigar os desafios enfrentados por essa população vulnerável, promovendo uma sociedade mais justa e inclusiva. 

Assuntos a serem explorados:
<dl>
    <dd>

#### Populacionais/espaciais: quantificar os indivíduos em situação de vulnerabilidade habitacional e mapear sua distribuição geográfica em território nacional.

**1.** Quantos indivíduos em condição de sem-teto são registrados no território brasileiro?

<details open><summary>...</summary>

<img src="https://github.com/mouraxy/puc/blob/main/data_engineering/img/historico_pop_rua.png" align="left"
     alt="historico_pop_rua">

***Resposta:** <br>De acordo com os dados mais recentes, que datam de 2021, o Brasil contava com 158.057 pessoas em situação de rua, refletindo uma diminuição em relação ao ápice observado em 2020, quando o número atingiu 194.824 indivíduos. Essas informações foram coletadas pelas administrações municipais e consolidadas por meio de uma colaboração entre o Ministério da Cidadania e o Observatório Brasileiro de Políticas Públicas.*

<img src="https://github.com/mouraxy/puc/blob/main/data_engineering/img/link.svg" align="center" align="left" 
     alt="acessar-dados">  Acessar os dados

<br>

**1.1** Por município (n25)?

<details open><summary>...</summary>

<img src="https://github.com/mouraxy/puc/blob/main/data_engineering/img/pop_rua_municipios.PNG" align="left"
     alt="pop_rua_municipios">

***Resposta:** <br>São Paulo lidera a lista dos 25 municípios com o maior número de pessoas em situação de rua, com um total de 37.200 indivíduos. Isso representa quatro vezes mais do que o número registrado em Belo Horizonte (segundo colocado).*

<br><br><br><br>

<img src="https://github.com/mouraxy/puc/blob/main/data_engineering/img/link.svg" align="center" align="left" 
     alt="acessar-dados">  Acessar os dados

<br>

</details>

**1.2** Por porte municipal?

<details><summary>...</summary>

<img src="https://github.com/mouraxy/puc/blob/main/data_engineering/img/pop_rua_porte.PNG" align="left"
     alt="pop_rua_porte">

***Resposta:** <br>81.286 moradores em situação de rua se concentram nas metrópoles e 54.685 nas cidades grandes. Embora essas áreas urbanas representem somente 5% dos municípios do país (283 de 5.570), elas concentram 86,02% do contingente destas pessoas.*

<br><br><br><br>

<img src="https://github.com/mouraxy/puc/blob/main/data_engineering/img/link.svg" align="center" align="left" 
     alt="acessar-dados">  Acessar os dados

<br>

</details>

**1.3** Por unidade federativa?

<details open><summary>...</summary>

<img src="https://github.com/mouraxy/puc/blob/main/data_engineering/img/pop_rua_uf.PNG" align="left"
     alt="pop_rua_uf">

***Resposta:** <br>O estado de São Paulo abriga uma população de 64.570 indivíduos vivendo em situação de rua, o qual representa uma parcela substancial de 40,8% de todo o contingente de pessoas nessa condição em território brasileiro. Notavelmente, essa estatística é 3,45 vezes superior à registrada em Minas Gerais e 4,76 vezes maior do que a do Rio de Janeiro.*

<br>

<img src="https://github.com/mouraxy/puc/blob/main/data_engineering/img/link.svg" align="center" align="left" 
     alt="acessar-dados">  Acessar os dados

<br>

</details>

</details>

**2.** Qual é a proporção da população brasileira que se encontra em situação de rua?

<details open><summary>...</summary>

**2.1** Por município?

<details><summary>...</summary>

<img src="https://github.com/mouraxy/puc/blob/main/data_engineering/img/%25pop_rua_municipios.PNG" align="left"
     alt="%pop_rua_municipios">

***Resposta:** <br> Boa Vista se sobressai como a cidade brasileira com a maior proporção de moradores em situação de rua em relação à sua população total. Além disso, a cidade registrou um notável crescimento populacional, passando de 284.313 habitantes em 2010 para 408.157 em 2022, um aumento de 30,34%.*

<br><br>

<img src="https://github.com/mouraxy/puc/blob/main/data_engineering/img/link.svg" align="center" align="left" 
     alt="acessar-dados">  Acessar os dados

<br>

</details>

**2.2** Por porte municipal?

<details><summary>...</summary>

<img src="https://github.com/mouraxy/puc/blob/main/data_engineering/img/%25pop_rua_porte.PNG" align="left"
     alt="%pop_rua_porte">

***Resposta:** <br>Embora a população de moradores de rua represente cerca de 0,08% da população total, essa parcela se concentra nas grandes metrópoles, com uma taxa de 0,183%. Essa taxa é mais de 2 vezes superior à média nacional, indicando que as metrópoles abrigam uma parcela desproporcionalmente maior em comparação com o país como um todo.*

<br>

<img src="https://github.com/mouraxy/puc/blob/main/data_engineering/img/link.svg" align="center" align="left" 
     alt="acessar-dados">  Acessar os dados

<br>

</details>

**2.3** Por unidade federativa?

<details open><summary>...</summary>

<img src="https://github.com/mouraxy/puc/blob/main/data_engineering/img/%25pop_rua_uf.PNG" align="left"
     alt="%pop_rua_uf">

***Resposta:** <br>Rondônia é o estado com a maior proporção de moradores de rua em relação à sua população total, registrando 0,309% (censo de 2022). Em segundo lugar está o Distrito Federal com 0,189% e São Paulo com 0,140%.*

<br><br><br><br><br>

<img src="https://github.com/mouraxy/puc/blob/main/data_engineering/img/link.svg" align="center" align="left" 
     alt="acessar-dados">  Acessar os dados

<br>

</details>

</details>

**3.** Quando e quais foram os maiores crescimentos ou declínios populacionais para o grupo em questão?

<details open><summary>...</summary>

<img src="https://github.com/mouraxy/puc/blob/main/data_engineering/img/variacao_pop_rua.PNG" align="left"
     alt="%var_pop_rua">

***Resposta:** <br>Desde o início da coleta de dados em 2012, os anos de 2013 e 2014 destacaram-se como os maiores aumentos na população em situação de rua, registrando crescimentos de 79% e 63%. Desde então, ocorreu somente uma diminuição, de -19% em 2019.*

<br><br><br><br>

<img src="https://github.com/mouraxy/puc/blob/main/data_engineering/img/link.svg" align="center" align="left" 
     alt="acessar-dados">  Acessar os dados

<br>

**3.1** Por município (n25)?

<details><summary>...</summary>

<img src="https://github.com/mouraxy/puc/blob/main/data_engineering/img/%25var_pop_rua_municipios.PNG" align="left"
     alt="%var_pop_rua_municipios">

***Resposta:** <br>No período de 2018 a 2022, Porto Alegre e Goiânia se destacaram pelos maiores declínios na população em situação de rua, com reduções de -16% e -11%. Por outro lado, Salvador, Joinville e Boa Vista apresentaram crescimentos superiores a 80% no número de moradores de rua durante o mesmo período.*

<br><br><br>

<img src="https://github.com/mouraxy/puc/blob/main/data_engineering/img/link.svg" align="center" align="left" 
     alt="acessar-dados">  Acessar os dados

<br>

</details>

**3.2** Por porte municipal?

<details><summary>...</summary>

<img src="https://github.com/mouraxy/puc/blob/main/data_engineering/img/%25var_pop_rua_porte.PNG" align="left"
     alt="%var_pop_rua_porte">

***Resposta:** <br> Embora tenha ocorrido um aumento de 14% entre 2018 e 2021 na população em situação de rua, esse acréscimo foi ainda mais substancial nas pequenas e médias cidades, onde as taxas excederam os 30%. É importante frisar que essa tendência não necessariamente reflete os maiores aumentos em termos absolutos.*

<br><br><br>

<img src="https://github.com/mouraxy/puc/blob/main/data_engineering/img/link.svg" align="center" align="left" 
     alt="acessar-dados">  Acessar os dados

<br>

</details>

**3.3** Por unidade federativa?

<details open><summary>...</summary>

<img src="https://github.com/mouraxy/puc/blob/main/data_engineering/img/%25var_pop_rua_uf.PNG" align="left"
     alt="%var_pop_rua_uf">

***Resposta:** <br>De 2018 a 2021, Roraima e Bahia viram suas populações de moradores de rua crescerem em 88% e 86%, enquanto Alagoas e Acre tiveram reduções de -23% e -13%. São Paulo e Rio Grande do Sul permaneceram relativamente estáveis em termos proporcionais.*

<br><br><br><br>

<img src="https://github.com/mouraxy/puc/blob/main/data_engineering/img/link.svg" align="center" align="left" 
     alt="acessar-dados">  Acessar os dados

<br>

</details>

</details>

**4.** A densidade demográfica está relacionada à concentração absoluta ou proporcional de pessoas em situação de rua?

<details><summary>...</summary>

***Resposta:** <br> Nos 25 municípios com a maior incidência de moradores em situação de rua, observa-se uma densidade média de 3.237 habitantes por quilômetro quadrado, enquanto nos demais municípios essa média se situa em 104 habitantes por quilômetro quadrado. Esse indicador ressalta a tendência de concentração dos indivíduos em situação de rua nas áreas urbanas caracterizadas por uma elevada densidade demográfica. É relevante notar que, dentre os 5.570 municípios do país, dados referentes à população em situação de rua não foram disponibilizados em 1.700 deles.*
     
</details>

<br><br>

#### Econômicos: associar o percentual médio de desempregados com as oscilações históricas dos desabrigados.

**1.** Qual é o coeficiente de correlação (*r*) entre as variáveis? Existe uma associação significativa entre elas?

<details open><summary>...</summary>

<img src="https://github.com/mouraxy/puc/blob/main/data_engineering/img/correlacao_desemprego.PNG" align="left"
     alt="correlacao_desemprego">

***Resposta:** <br> A correlação (r) é de aproximadamente 0,8983 (forte correlação positiva).* <br><br>  *Ou seja, à medida que a taxa média de desemprego aumenta, a população em situação de rua tende a aumentar também.*
​
<br><br><br><br><br><br>

<img src="https://github.com/mouraxy/puc/blob/main/data_engineering/img/link.svg" align="center" align="left" 
     alt="acessar-dados">  Acessar os dados

<br>

</details>

**2.** Em caso afirmativo, em quais situações elas apresentam uma maior ou menor relação?

<details><summary>...</summary>

<img src="https://github.com/mouraxy/puc/blob/main/data_engineering/img/convergencia_estatistica.PNG" align="left"
     alt="convergencia_estatistica">

***Resposta:** <br> Nos anos de 2013 e 2014, observa-se uma notável disparidade nos valores estatísticos, com percentuais de 80,51% e 69,01%, respectivamente. <br><br> Em contraste, os anos de 2016 e 2020 se destacam por apresentarem uma estreita concordância estatística, com diferenças ínfimas de apenas 5,25% e -0,91%, respectivamente.*

<br>

<img src="https://github.com/mouraxy/puc/blob/main/data_engineering/img/link.svg" align="center" align="left" 
     alt="acessar-dados">  Acessar os dados

<br>

</details>

<br><br>

#### Climáticos: identificar situações climáticas adversas, associadas ao risco hipotérmico e suscetibilidade a doenças.

**1.** Para os 25 municípios com as maiores concentrações de moradores em situação de rua...

<details open><summary>...</summary>

**1.1** Quais experimentam mais dias frios (< 13ºC) ao longo do ano, em média?

<img src="https://github.com/mouraxy/puc/blob/main/data_engineering/img/temperatura_municipios.PNG" align="left"
     alt="temperatura_municipios">

***Resposta:** <br> Em média, de 2019 a 2022, cidades como Sorocaba, Osasco, Porto Alegre, Campinas, São Bernardo, Guarulhos e São Paulo registraram mais de 40 dias com temperaturas mínimas inferiores a 13°C. Curitiba teve o maior valor, com 134 dias.<br><br>Em resumo, 90.479 pessoas (57,25% de toda a população em situação de rua do Brasil) estariam suscetíveis à hipotermia em 10% dos dias do ano.*

<img src="https://github.com/mouraxy/puc/blob/main/data_engineering/img/link.svg" align="center" align="left" 
     alt="acessar-dados">  Acessar os dados

<br>

**1.2** Quais destes são mais suscetíveis a enchentes (> 50mm) ao longo do ano, em média?

<img src="https://github.com/mouraxy/puc/blob/main/data_engineering/img/pluviosidade_municipios.PNG" align="left"
     alt="pluviosidade_municipios">

***Resposta:** <br>No período de 2019 a 2022, as cidades de Manaus, Salvador, Joinville, Fortaleza, Brasília e Florianópolis experimentaram, em média, entre 10 e 5 chuvas superiores a 50mm por ano.<br><br>Para as demais 19 cidades, a média manteve-se em aproximadamente 4 dias anuais com esse nível de precipitação.*

<br><br>

<img src="https://github.com/mouraxy/puc/blob/main/data_engineering/img/link.svg" align="center" align="left" 
     alt="acessar-dados">  Acessar os dados

<br>

</details>

  </dd>
</dl>
   
  </dd>
</dl>

## Coleta...
<dl>
    <dd>
         
<details open><summary>Dados e armazenamento...</summary>
<br>

Foram compilados 1773 conjuntos de dados provenientes da internet (**[clique aqui para acessar](https://github.com/mouraxy/puc/tree/main/data_engineering/data_lake)**) com formatos e estruturas diversas. Esta seleção objetivou emular cenários realistas de engenharia de dados, os quais frequentemente transcendem tabelas simples com dados homogêneos.

Os dados climáticos provenientes das estações meteorológicas automáticas (EMA) podem ser acessados através do **[INMET](https://portal.inmet.gov.br/dadoshistoricos)**.



## Pipeline ...

Todos os conjuntos de dados foram armazenados no `Data Lake Storage Gen2`, o Datalake da Microsoft. Para essa etapa, foi utilizado o `Azure Data Factory`, uma ferramenta para criar pipelines de ingestão automatizada.

  > <b>...</b> <br>
O pipeline centralizou todos os seis conjuntos de dados com diferentes fontes e formatos no Data Lake.

<!--
#### Erros de conexão...

Para garantir a integridade dos dados e evitar possíveis erros de conexão, implementou-se um tratamento de erros. Um aplicativo lógico foi configurado para monitorar a conexão e, caso ocorressem problemas, acionaria uma notificação por e-mail.

<dl>
    <dd>

<details><summary>Configuração do aplicativo lógico...</summary>
  
<br>
  
```json
{
    "properties": {
        "DataFactoryName": {
            "type": "string"
        },
        "ErrorMessage": {
            "type": "string"
        },
        "Pipeline": {
            "type": "string"
        },
        "Runid": {
            "type": "string"
        }
    },
    "type": "object"
}
```
</details>

  </dd>
</dl>

-->

</details>

  </dd>
</dl>
    
## Modelagem...
  <dl>
    <dd>

  <details open><summary>Organização dos dados...</summary>
  
  ## *Star schema...*
  Modelo em data warehouses, o Star Schema conecta tabela de `fatos` e `dimensões` por indentificadores distintos, formando uma estrutura de estrela. 
  
  > <b>...</b> <br>
  Embora reduza a necessidade de junções complexas, armazenamento e redundância são possíveis riscos associados.
  
  <br>Dado seu enfoque em ambientes de Business Intelligence (BI), `este modelo será incorporado ao MVP` com as respectivas **[tabelas...](https://github.com/mouraxy/puc/tree/main/data_engineering/data_lake)**
  
  </details>
  
  <details><summary>Metadados...</summary>

  ## Catálogo de dados...
  Um catálogo ou dicionário de dados é uma estrutura de governança e consiste em uma compilação de metadados em uma disposição informacional.
  
  ```Entidade: FACT_POP_RUA```
  | id | variavel                                     | tipo          | minimo       | maximo       | fonte                                                                                                           |
  |----|:---------------------------------------------|:-----:|:------------:|:------------:|:-----------------------------------------------------------------------------------------------------------------------:|       
  | 1  | id_municipio                                 |‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ inteiro‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ | 1.100.015    | 5.222.203    | [SNAS²](http://blog.mds.gov.br/redesuas/wp-content/uploads/2018/06/Lista_Munic%C3%ADpios_com_IBGE_Brasil_Versao_CSV.csv) |
  | 2  | id_porte                                     |inteiro‎|‎‎1‎‎ |‎ ‎ ‎ ‎ ‎ ‎ 5‎ ‎ ‎ ‎ ‎ ‎   |[SNAS²](http://blog.mds.gov.br/redesuas/wp-content/uploads/2018/06/Lista_Munic%C3%ADpios_com_IBGE_Brasil_Versao_CSV.csv) |
  | 3  | id_uf                                        |inteiro| 1            | 27           | [SNAS²](http://blog.mds.gov.br/redesuas/wp-content/uploads/2018/06/Lista_Munic%C3%ADpios_com_IBGE_Brasil_Versao_CSV.csv) |
  | 4  | id_regiao                                    |inteiro| 1            | 5            | [SNAS²](http://blog.mds.gov.br/redesuas/wp-content/uploads/2018/06/Lista_Munic%C3%ADpios_com_IBGE_Brasil_Versao_CSV.csv) |
  | 5  | latitude                                     |decimal| -33,69       | 4,60         | [Github](https://raw.githubusercontent.com/kelvins/Municipios-Brasileiros/main/csv/municipios.csv)                       |
  | 6  | longitude                                    |decimal‎|‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ -72,90‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ | -32,41       | [Github](https://raw.githubusercontent.com/kelvins/Municipios-Brasileiros/main/csv/municipios.csv)                       |
  | 7  | pop_censo_2010‎‎‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎  ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎  ‎ ‎ ‎ ‎ ‎   |inteiro| 805          |‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ 11.253.503‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ | [SNAS²](http://blog.mds.gov.br/redesuas/wp-content/uploads/2018/06/Lista_Munic%C3%ADpios_com_IBGE_Brasil_Versao_CSV.csv) |
  | 7  | pop_censo_2022‎‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎ ‎‎| inteiro      | -            | -            | [IBGE¹](https://ftp.ibge.gov.br/Censos/Censo_Demografico_2022/Previa_da_Populacao/POP2022_Municipios_20230622.xls)          |
  | 8  | pop_rua                                      | inteiro       | 0            | 48.134       | [UFMG³](https://obpoprua.direito.ufmg.br/tabelas/municipios_serie_historica_pop_rua.xlsx)                        |
  | 9  | pop_rua_ano                                  | inteiro       |     2012     | 2021         | [UFMG³](https://obpoprua.direito.ufmg.br/tabelas/municipios_serie_historica_pop_rua.xlsx)                        |
  
  <sub>¹ Instituto Brasileiro de Geografia e Estatística<br>
  ² Sistema Nacional de Assistência Social<br>
  ³ Universidade Federal de Minas Gerais<br>
  </sub>
  
  </details>

  </dd>
</dl>

## Carga...

`Databricks` <img align="center" src="https://cdn.safe.com/wp-content/uploads/sites/2/2023/03/27112124/databricks-icon.svg" alt="drawing" width="18"/> é uma plataforma escalável em nuvem que harmoniza os processos de Extração, Transformação e Carga (ETL) paralelamente.

> <b>...</b> <br>
Execução paralela envolve a realização simultânea de diversas operações visando otimizar a eficiência computacional.

<br>O uso do Databricks se mostra mais vantajoso em comparação ao emprego do **[expressor de consultas](https://learn.microsoft.com/en-us/azure/data-factory/data-flow-transformation-overview)** do `Azure Data Factory` <img align="center" src="https://ww1.freelogovectors.net/wp-content/uploads/2022/03/azure_data_factory_logo_freelogovectors.net_.png" alt="drawing" width="18"/>, devido à relativa complexidade estrutural do projeto e à capacidade de integração de linguagens (Python e SQL), além de conectores diversificados. 
<br>

<dl>
    <dd>
         
### Código ETL...

`Ponto de montagem...`
Recuperar os dados do contêiner (diretório) associado ao Data Lake da Azure.

<details><summary>Mostrar código...</summary>

```py
dbutils.fs.mount(source = "wasbs://puc@datalakenoblesix.blob.core.windows.net", mount_point = "/mnt/puc",
                 extra_configs = {"fs.azure.account.key.datalakenoblesix.blob.core.windows.net":"chave-de-acesso"})
```

</details>

</details>

<br>

`Ler aquivos...`
Criar DataFrames/visualizações temporárias com os dados do DL para tratativas subsequentes.

<details><summary>Mostrar código...</summary>

```py
df_moradores_rua = spark.read.format("csv")\
                                  .option("sep", ",")\
                                  .option("header", "true")\
                                  .option("inferSchema", "true")\
                                  .load("/mnt/puc/mvp/engenharia_dados/populacao_sem_teto.csv")

df_moradores_rua.createOrReplaceTempView("populacao_sem_teto")

df_municipios = spark.read.format("csv")\
                                          .option("sep", ";")\
                                          .option("header", "true")\
                                          .option("inferSchema", "true")\
                                          .option("encoding", "ISO-8859-1")\
                                          .load("/mnt/puc/mvp/engenharia_dados/municipios.csv")

df_coordenadas_dos_municipios = spark.read.format("csv")\
                                          .option("sep", ",")\
                                          .option("header", "true")\
                                          .option("inferSchema", "true")\
                                          .load("/mnt/puc/mvp/engenharia_dados/dim_coordenadas_municipios.csv")
```

</details>

<br>

`Tratar dados...` Renomear e remover variáveis. Também reestruturar as tabelas seguindo o modelo de dados estrela. 
  
> <b>...</b> <br>
A criação de um DW nesse esquema facilitará substancialmente o trabalho no Power BI.

<details><summary>Mostrar código...</summary>

```py
colunas_para_excluir = ['ConcatUF+Mun', 'IBGE', 'Capital', '_c9']
df_municipios = df_municipios.drop(*colunas_para_excluir)

df_municipios = df_municipios.withColumnRenamed('IBGE7', 'id_municipio')\
                             .withColumnRenamed('UF', 'uf')\
                             .withColumnRenamed('Município', 'municipio')\
                             .withColumnRenamed('Região', 'regiao')\
                             .withColumnRenamed('População 2010', 'populacao_censo_2010')\
                             .withColumnRenamed('Porte', 'porte')

df_moradores_rua = df_moradores_rua.withColumnRenamed('populacao', 'moradores_rua')\
                                             .withColumnRenamed('ano', 'ano_levantamento')

df_coordenadas_dos_municipios.createOrReplaceTempView("COORDENADAS_MUNICIPIOS")
df_municipios.createOrReplaceTempView("MUNICIPIOS")
df_moradores_rua.createOrReplaceTempView("MORADORES_RUA")

df_municipios_id = spark.sql(""" SELECT municipio
                          FROM MUNICIPIOS
                          ORDER BY municipio
""")

df_municipios_id = df_municipios_id.withColumn('id_municipio', monotonically_increasing_id()+1)
df_municipios_id.createOrReplaceTempView("DIM_MUNICIPIOS")

df_regiao = spark.sql(""" SELECT DISTINCT regiao
                          FROM MUNICIPIOS
                          ORDER BY regiao
""")

df_regiao = df_regiao.withColumn('id_regiao', monotonically_increasing_id()+1)
df_regiao.createOrReplaceTempView("DIM_REGIAO")

df_estado = spark.sql(""" SELECT DISTINCT uf
                          FROM MUNICIPIOS
                          ORDER BY uf
""")

df_estado = df_estado.withColumn('id_uf', monotonically_increasing_id()+1)
df_estado.createOrReplaceTempView("DIM_UNIDADE_FEDERATIVA")

df_porte = spark.sql(""" SELECT DISTINCT porte
                          FROM MUNICIPIOS
                          ORDER BY porte
""")

df_porte = df_porte.withColumn('id_porte', monotonically_increasing_id()+1)
df_porte.createOrReplaceTempView("DIM_PORTE_MUNICIPIO")

df_fato = spark.sql("""
                    SELECT 
                        M.id_municipio, U.id_uf, R.id_regiao, C.latitude, C.longitude, P.id_porte,
                        M.populacao_censo_2010, MR.moradores_rua, MR.ano_levantamento

                        FROM MUNICIPIOS M
                        LEFT JOIN MORADORES_RUA MR ON MR.id_municipio = M.id_municipio
                        LEFT JOIN COORDENADAS_MUNICIPIOS C ON C.id_municipio = M.id_municipio
                        LEFT JOIN DIM_REGIAO R ON R.regiao = M.regiao
                        LEFT JOIN DIM_UNIDADE_FEDERATIVA U ON U.uf = M.uf
                        LEFT JOIN DIM_PORTE_MUNICIPIO P ON P.porte = M.porte

                        ORDER BY M.id_municipio
""")

```

</details>

<br>

`Carregar...`
Importar os dados para o banco de dados SQL na nuvem. 

  > <b>...</b> <br>
  Previamente, foi necessário preparar o ambiente na Azure por meio das instruções DDL. Você pode acessá-las **[aqui!](https://github.com/mouraxy/puc/blob/main/data_engineering/sql/ddl.sql)**

<details><summary>Mostrar código...</summary>

```py
def carga_sql(df, tabela):
    df.write.format("jdbc")\
            .mode("append")\
            .option("url", "jdbc:sqlserver://mouraxy.database.windows.net")\
            .option("port", "1433")\
            .option("user", "mouraxy")\
            .option("password", "senha-banco-de-dados")\
            .option("database", "bd_mouraxy")\
            .option("dbtable", tabela)\
            .save()

carga_sql(df_municipios_id, "DW.DIM_MUNICIPIO")
carga_sql(df_regiao, "DW.DIM_REGIAO")
carga_sql(df_estado, "DW.DIM_UNIDADE_FEDERATIVA")
carga_sql(df_porte, "DW.DIM_PORTE_MUNICIPIO")
carga_sql(df_fato, "DW.FACT_POP_RUA")
```

</details>

  </dd>
</dl>

## Revisão...

<dl>
 <dd>
  <details><summary>Qualidade de dados...</summary>
               
  </details>

  <details><summary>Solução do problema...</summary>
                          
  </details>

 </dd>
</dl>























